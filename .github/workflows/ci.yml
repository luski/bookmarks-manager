name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "23.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run Biome CI
        run: npm run ci

  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "23.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "23.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: dist
          path: dist/
          retention-days: 1

  test-database:
    name: Test Database Operations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "23.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Initialize database
        run: npm run db:migrate

      - name: Test database operations
        run: |
          # Test adding bookmarks
          npm run bookmarks add "https://github.com" "GitHub" "Test bookmark" "test"
          npm run bookmarks add "https://nodejs.org" "Node.js" "Runtime" "nodejs,test"

          # Test listing
          npm run bookmarks list

          # Test search
          npm run bookmarks search "test"

          # Test delete
          npm run bookmarks delete 1

          # Verify bookmark was deleted
          RESULT=$(npm run bookmarks list 2>/dev/null | grep -c "GitHub" || true)
          if [ "$RESULT" != "0" ]; then
            echo "Delete operation failed"
            exit 1
          fi

          echo "All database operations passed!"

      - name: Upload database artifact
        uses: actions/upload-artifact@v5
        with:
          name: test-database
          path: bookmarks.db*
          retention-days: 1

  test-node-version:
    name: Test on Node.js ${{ matrix.node-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ["23.x", "latest"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build and test
        run: |
          npm run build
          npm run db:migrate
          npm run bookmarks add "https://test.com" "Test" "Description" "tags"
          npm run bookmarks list
